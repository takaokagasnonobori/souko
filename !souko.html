<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="style-src 'self' https://www.gstatic.com;">
  <title>å€‰åº«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #scanner { width: 300px; margin-bottom: 20px; }
    #log { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .mode-btn { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</h2>

  <div>
    <button class="mode-btn" onclick="setMode('å…¥åº«')">ğŸ“¥ å…¥åº«</button>
    <button class="mode-btn" onclick="setMode('å‡ºåº«')">ğŸ“¤ å‡ºåº«</button>
    <strong>ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰: <span id="current-mode">å…¥åº«</span></strong>
  </div>

  <div id="scanner"></div>

  <label>æ•°é‡: <input type="number" id="quantity" min="1" value="1"></label>
  <button onclick="saveLog()">è¨˜éŒ²</button>

  <h3>èª­ã¿å–ã‚Šå±¥æ­´</h3>
  <div id="log"></div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <script>
    let lastScanned = "";
    let currentMode = "å…¥åº«";
    let html5QrCode;
    let scannerRunning = false;

    function setMode(mode) {
      currentMode = mode;
      document.getElementById("current-mode").innerText = mode;
    }

    function startScanner() {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          if (!scannerRunning) return;

          lastScanned = decodedText;
          document.getElementById("log").innerHTML += `<div>ğŸ“¦ èª­ã¿å–ã‚Š: ${decodedText}</div>`;
          document.getElementById("beep").play();

          // ã‚¹ã‚­ãƒ£ãƒ³ä¸€æ™‚åœæ­¢
          html5QrCode.stop();
          scannerRunning = false;
        },
        (errorMessage) => {
          // èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
      ).then(() => {
        scannerRunning = true;
      }).catch(err => {
        console.error("èª­ã¿å–ã‚Šé–‹å§‹å¤±æ•—:", err);
      });
    }

    function saveLog() {
      if (!lastScanned) return;
      const qty = document.getElementById("quantity").value;

      fetch("https://script.google.com/macros/s/AKfycbwUS9FVirDJmkhf79BOFrvTrM4mY6G-gw26tNJceiMPDGzUhvo-ptQik2zvF6tHlHo/exec", {
  method: "POST",
  body: JSON.stringify({
    code: lastScanned,
    quantity: qty,
    mode: currentMode
  }),
  headers: { "Content-Type": "application/json" }
})
.then(res => res.text())
.then(txt => {
  document.getElementById("log").innerHTML += `<div>âœ… ${currentMode}: ${lastScanned} x ${qty} ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚</div>`;
  lastScanned = ""; // åˆæœŸåŒ–
  startScanner(); // ã‚¹ã‚­ãƒ£ãƒ³å†é–‹
})
.catch(err => {
  console.error("è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:", err);
});
