<!souko html>
<html>
<head>
  <meta charset="UTF-8">
  <title>倉庫バーコード管理</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #scanner { width: 300px; margin-bottom: 20px; }
    #log { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .mode-btn { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>バーコード読み取り</h2>

  <div>
    <button class="mode-btn" onclick="setMode('入庫')">📥 入庫</button>
    <button class="mode-btn" onclick="setMode('出庫')">📤 出庫</button>
    <strong>現在モード: <span id="current-mode">入庫</span></strong>
  </div>

  <div id="scanner"></div>

  <label>数量: <input type="number" id="quantity" min="1" value="1"></label>
  <button onclick="saveLog()">記録</button>

  <h3>読み取り履歴</h3>
  <div id="log"></div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <script>
    let lastScanned = "";
    let currentMode = "入庫";

    function setMode(mode) {
      currentMode = mode;
      document.getElementById("current-mode").innerText = mode;
    }

    function saveLog() {
      if (!lastScanned) return;
      const qty = document.getElementById("quantity").value;

      fetch("https://script.google.com/macros/s/AKfycbyR2iLgmFKnjNG7zJ6WvXYGX7ohepg73-tFDRXUdTxEMKnGrmdtCuSldHsQMHvSo1R_/exec", {
        method: "POST",
        body: JSON.stringify({
          code: lastScanned,
          quantity: qty,
          mode: currentMode
        }),
        headers: { "Content-Type": "application/json" }
      }).then(res => res.text()).then(txt => {
        document.getElementById("log").innerHTML += `<div>✅ ${currentMode}: ${lastScanned} x ${qty} を保存しました。</div>`;
      });
    }

    const beepSound = document.getElementById("beep");

    const html5QrCode = new Html5Qrcode("scanner");
    html5QrCode.start({ facingMode: "environment" }, {
      fps: 10,
      qrbox: 250
    }, (decodedText) => {
      lastScanned = decodedText;
      document.getElementById("log").innerHTML += `<div>📦 読み取り: ${decodedText}</div>`;
      beepSound.play(); // 成功時の音
    }, (errorMessage) => {
      // 読み取り失敗は無視
    });
  </script>
</body>
</html>
